apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Chart.Name }}-configmap
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}-configmap
    app.kubernetes.io/version: "{{ .Values.version }}"
    app.kubernetes.io/component: application
    app.kubernetes.io/part-of: micro-services
    app.kubernetes.io/managed-by: helm
data:
  10-create-data.sql: |
    CREATE ROLE program WITH PASSWORD 'postgres';
    ALTER ROLE program WITH LOGIN;

    CREATE DATABASE main;
    GRANT ALL PRIVILEGES ON DATABASE main TO program;

    CREATE TABLE reservation
    (
        id              bigint generated by default as identity primary key,
        reservation_uid uuid        not null,
        payment_uid     uuid        not null,
        hotel_id        integer     not null,
        status          varchar(20) not null
            constraint reservation_status_check
                check ((status)::text = ANY
                       (ARRAY [('PAID'::character varying)::text, ('CANCELED'::character varying)::text])),
        start_date      timestamp,
        end_date        timestamp
    );

    CREATE TABLE hotels
    (
        id        bigint generated by default as identity primary key,
        hotel_uid uuid         not null,
        name      varchar(255) not null,
        country   varchar(80)  not null,
        city      varchar(80)  not null,
        address   varchar(255) not null,
        stars     integer,
        price     integer      not null
    );

    INSERT INTO hotels (id, hotel_uid, name, country, city, address, stars, price)
    VALUES (1, '049161bb-badd-4fa8-9d90-87c9a82b0668', 'Ararat Park Hyatt Moscow', 'Россия', 'Москва',
            'Неглинная ул., 4', 5, 10000);

    CREATE TABLE payment
    (
        id          bigint generated by default as identity
            primary key,
        payment_uid uuid        not null,
        status      varchar(20) not null
            constraint reservation_status_check
                check ((status)::text = ANY
                       (ARRAY [('PAID'::character varying)::text, ('CANCELED'::character varying)::text])),
        price       integer     not null
    );

    CREATE TABLE loyalty
    (
        id                bigint generated by default as identity
            primary key,
        username          varchar(80) not null,
        reservation_count integer     not null default 0,
        status            varchar(80)          default 'BRONZE'::character varying
            constraint books_condition_check
                check ((status)::text = ANY
                       ((ARRAY ['BRONZE'::character varying, 'SILVER'::character varying, 'GOLD'::character varying])::text[])),
        discount          integer     not null
    );

    INSERT INTO loyalty (id, username, reservation_count, status, discount)
    VALUES (1, 'Test Max', 25, 'GOLD', 10);